<div class="cart-details-container">
  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Carregando detalhes do carrinho...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="error-message">
    <p>{{ errorMessage }}</p>
    <button (click)="clearErrorMessage()" class="error-close-button">√ó</button>
  </div>

  <!-- Success Message -->
  <div *ngIf="successMessage" class="success-message">
    <p>{{ successMessage }}</p>
  </div>

  <!-- Cart Details -->
  <div *ngIf="cart && !loading" class="cart-content">
    <!-- Header -->
    <div class="cart-header">
      <button (click)="goBack()" class="back-button">
        ‚Üê Voltar
      </button>
      <h1>Detalhes do Carrinho</h1>
      <div class="cart-status">
        <span class="status-badge" [ngClass]="getStatusClass()">
          {{ getStatusText(cart.status) }}
        </span>
      </div>
    </div>

    <!-- Cart Info -->
    <div class="cart-info">
      <div class="info-section">
        <h3>Informa√ß√µes do Cliente</h3>
        <div class="info-grid">
          <div class="info-item">
            <strong>Nome:</strong>
            <span>{{ cart.user.name }}</span>
          </div>
          <div class="info-item">
            <strong>Email:</strong>
            <span>{{ cart.user.email }}</span>
          </div>
          <div class="info-item">
            <strong>ID do Carrinho:</strong>
            <span>{{ cart.id }}</span>
          </div>
          <div class="info-item">
            <strong>Status:</strong>
            <span [ngClass]="getStatusClass()">{{ getStatusText(cart.status) }}</span>
          </div>
        </div>
      </div>

      <!-- Products Section -->
      <div class="products-section">
        <h3>Produtos do Carrinho</h3>
        <div class="products-list">
          <div *ngFor="let product of cart.productResponses; let i = index" class="product-item">
            <div class="product-image">
              <img *ngIf="product.imgUrl" [src]="product.imgUrl" [alt]="product.name" />
              <div *ngIf="!product.imgUrl" class="no-image">
                <span>Sem imagem</span>
              </div>
            </div>
            <div class="product-details">
              <h4>{{ product.name }}</h4>
              <p class="product-description">{{ product.description }}</p>
              <div class="product-info">
                <span class="quantity">Quantidade: {{ product.quantity }}</span>
                <span class="price">Pre√ßo: {{ formatPrice(product.price) }}</span>
                <span class="total">Total: {{ formatPrice(product.price * product.quantity) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Total Section -->
      <div class="total-section">
        <div class="total-item">
          <strong>Total do Carrinho:</strong>
          <span class="total-price">{{ formatPrice(cart.totalPrice) }}</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button 
          *ngIf="isCartOpen()" 
          (click)="redirectToWhatsApp()" 
          class="whatsapp-button"
        >
          üì± Reenviar Mensagem para Vendedor
        </button>
        
                  <form
            *ngIf="cart && cart.status === 'SOLD' && !feedback"
            class="feedback-avaliation"
            (ngSubmit)="submitFeedback()"
            #feedbackForm="ngForm"
          >
            <h3>Avalia√ß√£o do Carrinho</h3>
            <div>
              <label for="feedback-description">Descri√ß√£o:</label>
              <textarea
                id="feedback-description"
                name="description"
                [(ngModel)]="feeedbackForm.description"
                rows="4"
                required
              ></textarea>
            </div>
            <div>
              <label for="feedback-rating">Nota:</label>
              <input
                type="number"
                id="feedback-rating"
                name="rating"
                min="1"
                max="5"
                [(ngModel)]="feeedbackForm.rating"
                required
              />
            </div>
            <button type="submit" [disabled]="!feedbackForm.form.valid">Enviar Avalia√ß√£o</button>
          </form>

          <div *ngIf="feedback && !isEditing" class="feedback-display">
              <h3>Sua Avalia√ß√£o</h3>
              <div class="feedback-item">
                <strong>Descri√ß√£o:</strong>
                <span>{{ feedback.description }}</span>
              </div>
              <div class="feedback-item">
                <strong>Nota:</strong>
                <span>{{ repeatStars(feedback.rating) }}</span>
              </div>
              <button (click)="startEditing()" class="edit-button">‚úèÔ∏è Editar Avalia√ß√£o</button>
          </div>

          <form
            *ngIf="cart && cart.status === 'SOLD' && isEditing"
            class="feedback-avaliation"
            (ngSubmit)="updateFeedback()"
            #feedbackForm="ngForm">
            <h3>Editar Avalia√ß√£o do Carrinho</h3>
            <div>
              <label for="feedback-description">Descri√ß√£o:</label>
              <textarea
                id="feedback-description"
                name="description"
                [(ngModel)]="feeedbackForm.description"
                rows="4"
                required
              ></textarea>
            </div>
            <div>
              <label for="feedback-rating">Nota:</label>
              <input
                type="number"
                id="feedback-rating"
                name="rating"
                min="1"
                max="5"
                [(ngModel)]="feeedbackForm.rating"
                required/>
            </div>
            <div class="edit-buttons">
              <button type="submit" [disabled]="!feedbackForm.form.valid">Atualizar Avalia√ß√£o</button>
              <button type="button" (click)="cancelEditing()" class="cancel-button">Cancelar</button>
            </div>
          </form>
        </div>
    </div>
  </div>
</div>